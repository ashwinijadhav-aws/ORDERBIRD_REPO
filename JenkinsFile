pipeline {
  agent any 
  tools { maven 'Maven_Local' }
  stages {
    stage('Checkout') {
      steps {
        sh 'echo passed'
        sh 'printenv'
        //git branch: 'main', url: 'https://github.com/ashwinijadhav-aws/ORDERBIRD_K8S_ARGOCD'
      }
    } 
    stage('Build and Test') {
      steps {
        sh 'ls -ltr'
        // build the project and create a JAR file
        sh 'mvn clean package'
      }
    }
  /*  stage('Static Code Analysis') {
      environment {
        SONAR_URL = "http://18.192.66.2:9000"
      }
      steps {
        withCredentials([string(credentialsId: 'sonar-cred', variable: 'SONAR_AUTH_TOKEN')]) {
          sh 'mvn sonar:sonar -Dsonar.login=$SONAR_AUTH_TOKEN -Dsonar.host.url=${SONAR_URL}'
        }
      }
    }*/
    stage('Build Docker Image') {
        environment {
          DOCKER_IMAGE = "ashwinijadhavaws/orderbird-app-prod-image:${BUILD_NUMBER}"
        }
        steps {
          script {
              sh 'docker build -t ${DOCKER_IMAGE} .'
              }
          }
    }
    stage('Scan image with Trivy') {
            steps {
              //  sh 'trivy image --exit-code 1 --ignore-unfixed --severity HIGH,CRITICAL --format json --output results.json ashwinijadhavaws/orderbird-app-prod-image:${BUILD_NUMBER}'
              sh 'trivy image --exit-code 1  --severity HIGH,CRITICAL  --format json --output results.json --ignorefile .trivyignore ashwinijadhavaws/orderbird-app-prod-image:${BUILD_NUMBER}'

            }
    }
    stage('Push Docker Image') {
            environment {
              REGISTRY_CREDENTIALS = credentials('docker-cred')
              DOCKER_IMAGE = "ashwinijadhavaws/orderbird-app-prod-image:${BUILD_NUMBER}"
            }
            steps {
              script {
                      def dockerImage = docker.image("${DOCKER_IMAGE}")
                      docker.withRegistry('https://index.docker.io/v1/', "docker-cred") {
                      dockerImage.push()
                  }
              }
           }
   }

  stage('Clone repository') {
            steps {
                git branch: 'main', url: "https://github.com/ashwinijadhav-aws/ORDERBIRD_K8S_MANIFEST_REPO"
                sh 'ls -ltr'
                sh 'pwd'
            }
    }

   stage('Update Deployment File') {
        environment {
            GIT_REPO_NAME = "ORDERBIRD_K8S_MANIFEST_REPO"
            GIT_USER_NAME = "ashwinijadhav-aws"
        }
        steps {
            withCredentials([string(credentialsId: 'GITHUB_TOKEN', variable: 'GITHUB_TOKEN')]) {
                sh '''
                    git config user.email "ashwinijadhav243@gmail.com"
                    git config user.name "ashwinijadhav-aws"
                    BUILD_NUMBER=${BUILD_NUMBER}
                    sed -i 's|image: ${GIT_USER_NAME}/${GIT_REPO_NAME}.*|image: ${GIT_USER_NAME}/${GIT_REPO_NAME}:${BUILD_NUMBER}|g' app_deployment.yml
                    git add SPRING-BOOT-APP-MANIFEST/app_deployment.yml
                    git commit -m "Update deployment image to version ${BUILD_NUMBER}"
                    git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main
                '''

            }
  }
   
  }
  }

   post {
        always {
                archiveArtifacts artifacts: "results.json", fingerprint: true
            }
        } 
}
